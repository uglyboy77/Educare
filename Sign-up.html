<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIGN-UP</title>
  <link rel="icon" type="image/png" href="../assets/EduCare Logo.png" />
  <link rel="stylesheet" href="CSS.css" type="text/css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>
  <div class="background">
    <div class="LogIn-container">
      <div class="logo">
        <img src="../assets/EduCare Logo.png" alt="EDUCARE Logo" class="image1" />
      </div>
      <h1>Welcome to EDUCARE</h1>
      <h2>SIGN UP</h2>
      <form id="signupForm" enctype="multipart/form-data">
        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="firstname" name="firstname" placeholder="First Name" required />
        </div>

        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="lastname" name="lastname" placeholder="Last Name" required />
        </div>

        <div class="input-group">
          <i class="fas fa-user-plus"></i>
          <input type="text" id="othernames" name="othernames" placeholder="Other Names" />
        </div>

        <div class="input-group">
          <i class="fas fa-envelope"></i>
          <input type="email" id="username" name="username" placeholder="Email" required />
        </div>

        <div class="input-group">
          <i class="fas fa-phone"></i>
          <input type="number" id="phone" name="phone" placeholder="Phone Number" required />
        </div>
        <div class="input-group">
          <i class="fas fa-book"></i>
          <select id="course" name="course" required>
            <option value="" disabled selected>Select Course according to your year</option>
            <option value="Computer-Science-Y1">Computer Science-Year 1</option>
            <option value="Economics-Y2">Economics-Year 2</option>
          </select>
        </div>
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="password" placeholder="Password" required autocomplete="current-password" />
          <i class="fas fa-eye toggle-password" onclick="togglePassword()"></i>
        </div>
        <br />
        <span>Upload Student Photo:</span>
        <i class="fa-solid fa-camera-retro"></i> <br />
        <input type="file" id="profilePicture" name="profilePicture" accept="image/*" />

        <br><br>
        <button type="submit">Sign Up</button>
      </form>

      <p>Already have an account? <a href="../index.html">Log In</a></p>
      <footer>
        <p>&copy; 2025 EDUCARE. All rights reserved.</p>
      </footer>
    </div>
  </div>

  <script>
    function togglePassword() {
      const passwordInput = document.getElementById("password");
      const toggleIcon = document.querySelector(".toggle-password");
      const isVisible = passwordInput.type === "text";
      passwordInput.type = isVisible ? "password" : "text";
      toggleIcon.classList.toggle("fa-eye");
      toggleIcon.classList.toggle("fa-eye-slash");
    }

    document.getElementById('signupForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const courseValue = document.getElementById('course').value;
      const studentId = generateStudentId(courseValue);

      function generateStudentId(courseValue) {
        const middle = Math.floor(100 + Math.random() * 900);

        let prefix, suffix;

        if (courseValue === "Computer-Science-Y1") {
          prefix = "21";
          suffix = "24";
        } else if (courseValue === "Economics-Y2") {
          prefix = "31";
          suffix = "23";
        } else {
          throw new Error("Unsupported course/year");
        }

        return `${prefix}${middle}${suffix}`;
      }

      const formData = new FormData();
      formData.append("studentId", studentId);
      formData.append("firstName", document.getElementById('firstname').value);
      formData.append("middleName", document.getElementById('othernames').value);
      formData.append("lastName", document.getElementById('lastname').value);
      formData.append("email", document.getElementById('username').value);
      formData.append("phoneNumber", document.getElementById('phone').value);
      formData.append("password", document.getElementById('password').value);
      formData.append("course", courseValue);
      const profilePicture = document.getElementById('profilePicture').files[0];
      if (profilePicture) {
        formData.append("image", profilePicture);
      }

      fetch('http://localhost:3000/signup', {
        method: 'POST',
        body: formData
      })
        .then(async res => {
          const data = await res.json();

          if (!res.ok) {
            if (res.status === 409) {
              alert("❌ You already have an account with this email. Redirecting to login...");
              window.location.href = "../index.html";
            } else {
              alert(`❌ Signup failed: ${data.error}`);
            }
            throw new Error(data.error);
          }

          console.log(data.message);
          localStorage.setItem("studentId", formData.get("studentId"));

          return fetch(`http://localhost:3000/student-info/${formData.get("studentId")}`);
        })
        .then(res => res.json())
        .then(data => {
          window.location.href = "../Student-portal/Student-Portal.html";
        })
        .catch(err => console.error('❌ Signup error:', err));
    });
  </script>
</body>

</html>
