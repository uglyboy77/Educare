<!DOCTYPE html>
<html lang="eng">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Student Portal</title>
  <link rel="icon" type="image/png" href="../assets/EduCare Logo.png" />
  <link rel="stylesheet" href="student-portal-style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
</head>

<body>
  <div class="info">
    <img src="../assets/R.jpg" class="bgImage">
    <div class="menus" onclick="togglemenuDown(this)">
      <div class="menu"></div>
      <div class="menu"></div>
      <div class="menu"></div>
      <div class="dropdown-menu">
        <a href="../student-info/Student-Info.html" class="dropdown-item"><i class="fas fa-user"></i> Student Info</a>
        <a href="https://www.knust.edu.gh/" class="dropdown-item"><i class="fas fa-school"></i> School Info</a>
        <a href="../messages/messages.html" class="dropdown-item">
          <i class="fas fa-envelope"></i> Messages
          <!--  <span id="unreadCount" class="badge"></span> -->
        </a>
        <a href="../map/Map.html" class="dropdown-item"><i class="fas fa-map"></i> Map</a>
        <a href="../index.html" class="dropdown-item"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
      </div>
    </div>
    <h2 id="student-name"></h2>
    <div class="imagecontainer">
      <div class="imageWrapper">
        <img id="img" src="" alt="upload photo" class="userImage">
      </div>
    </div>
  </div>

  <div class="studentBody">
    <div class="studentInfobox1">
      <a href="../courses/Course.html">
        <p>courses <i class="fas fa-book"></i></p>
      </a>
    </div>

    <div class="studentInfobox2">
      <a href="../BillsandPayments/BillsandPayment.html">
        <p>Bills & <br> Payments <i class="fas fa-money-bill-wave"></i></p>
      </a>
    </div>

    <div class="studentInfobox3">
      <a href="../results/Results-page.html">
        <p>Check Results <i class="fas fa-graduation-cap"></i></p>
      </a>
    </div>

    <div class="studentInfobox4">
      <a href="../registrations/Registration-page.html">
        <p>Registrations <i class="fas fa-check-circle"></i></p>
      </a>
    </div>

    <div class="Transcript-container">
      <div class="studentInfobox5">
        <p>Transcript <br> Request <i class="fas fa-file-alt"></i></p>
      </div>
      <div class="Transcript-request-container">
        <div class="Transcript-request">
          <div class="Tanscript-request">
            <div class="dialog">Transcript requested!<br> Come back in 72 hours later.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="studentInfobox6">
      <a href="../accesslecturers/AccessLecturers.html">
        <p>Access Lecturers <i class="fas fa-chalkboard-teacher"></i></p>
      </a>
    </div>
  </div>
  <div class="news">
    <h2 class="news-title">news and announcements</h2>
    <div class="news1 news-item">
      <img src="" alt="newsphoto" class="newsImage news-img">
      <p class="news-text"><strong>Latest News will appear here.</strong></p>
    </div>
  </div>
  <div class="FAQ">
    <h2 class="FAQ-title">Frequently Asked Questions (FAQs)</h2>
    <div class="FAQ-item">
      <h3 class="FAQ-question">How do I register a course?</h3>
      <p class="FAQ-answer">To register a course, log into your student portal, navigate to the "Course" section and
        follow the instructions provided.</p>
    </div>
    <div class="FAQ-item">
      <h3 class="FAQ-question">How can I view my grades?</h3>
      <p class="FAQ-answer">You can view your grades by logging into your student portal and navigating to the
        "Check Results" page.</p>
    </div>
    <div class="FAQ-item">
      <h3 class="FAQ-question">Where can I find the academic calendar?</h3>
      <p class="FAQ-answer">The academic calendar is available on the university's official website under the
        "Academics" section.</p>
    </div>
  </div>
  <section>
    <div class="sendMessage">
      <h2 class="sendMessage-title">Send us a message</h2>
      <form id="feedbackForm" class="message-form">
        <input type="text" id="name" name="name" placeholder="Your Name" required class="message-input"><br><br>
        <input type="email" id="email" name="email" placeholder="Your Email" required class="message-input"><br><br>
        <textarea id="message" name="message" placeholder="Your Message" required
          class="message-textarea"></textarea><br><br>
        <button type="submit" class="message-button">Send Message <i class="fa fa-paper-plane"></i></button>
      </form>

      <div id="congrats-message" style="display:none; color:green; font-weight:bold; margin-top:10px;">
        Thank you! We've received your feedback.
      </div>
    </div>
  </section>
  <!-- <script src="messages/messages-js.js"></script> -->
  <script>
    fetch(`${API_BASE}/debug-db`)
  .then(res => res.json())
  .then(data => console.log("All students:", data));

    
    const API_BASE = "https://educare-students-hub-eadz.onrender.com";
    
    window.addEventListener("load", () => {
      const studentId = localStorage.getItem("studentId");
      if (!studentId) return;

      fetch(`${API_BASE}/student-info/${studentId}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("student-name").textContent = `Hello, ${data.name}`;
          if (data.image) {
            document.getElementById("img").src = `${API_BASE}${data.image}`;
          } else {
            document.getElementById("img").removeAttribute("src");
            document.getElementById("img").alt = "No photo uploaded";
          }
        })
        .catch(err => console.error("‚ùå Failed to load student info:", err));

      renderMessages();
      showTranscript();
    });

    /* 
    window.addEventListener("load", updateBadgeFromStorage);
    window.addEventListener("storage", (event) => {
      if (event.key === "messages") {
        updateBadgeFromStorage();
      }
    }); */

    function togglemenuDown(element) {
      const menu = element.querySelector('.dropdown-menu');
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
      element.classList.toggle('active');
      document.addEventListener('click', function handler(e) {
        if (!element.contains(e.target)) {
          menu.style.display = 'none';
          element.classList.remove('active');
          document.removeEventListener('click', handler);
        }
      });
    }

    function showTranscript() {
      const transcriptMsg = document.querySelector(".Transcript-request-container");
      const transcriptContainer = document.querySelector(".Transcript-container");
      const studentId = localStorage.getItem("studentId");

      if (transcriptContainer && transcriptMsg && studentId) {
        transcriptContainer.addEventListener('click', function handler(e) {

          transcriptMsg.style.display = 'inline-block';
          setTimeout(function () {
            transcriptMsg.style.display = 'none';
          }, 2000);

          fetch(`${API_BASE}/request-transcript`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ studentId })
          })
            .then(res => res.json())
            .then(data => {
              console.log("üìÑ Transcript request response:", data.message);
            })
            .catch(err => {
              console.error("‚ùå Failed to request transcript:", err);
            });
        });
      }
    }

    document.getElementById("feedbackForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const studentId = localStorage.getItem("studentId");
      const name = document.getElementById("name").value;
      const studentEmail = document.getElementById("email").value;
      const message = document.getElementById("message").value;

      const payload = { studentId, name, studentEmail, message };
      try {
        const res = await fetch(`${API_BASE}/submit-feedback`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        console.log("üì® Server response:", data.message);

        document.getElementById("congrats-message").style.display = "block";

        document.getElementById("feedbackForm").style.display = "none";
      } catch (err) {
        console.error("‚ùå Failed to submit feedback:", err);
        alert("Something went wrong. Please try again.");
      }
    });

    function renderMessages() {
      console.log("renderMessages placeholder loaded");
    }
    renderMessages();
    showTranscript();

  </script>
</body>

</html>
